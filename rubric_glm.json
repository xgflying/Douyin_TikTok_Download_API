[
  {
    "rubric_id": "R01",
    "rubric_content": "在 bilibili_web.py 中新增 GET /down_video 接口且可被路由访问",
    "score": "1",
    "rationale": "已在 bilibili_web.py 中新增 @router.get(\"/down_video\") 路由，接口可被路由访问，满足要求"
  },
  {
    "rubric_id": "R02",
    "rubric_content": "接口必须包含 bv_id 必填参数（作品 id）",
    "score": "1",
    "rationale": "down_video 的函数签名包含 bv_id 参数且无默认值，满足必填参数要求"
  },
  {
    "rubric_id": "R03",
    "rubric_content": "接口必须对 bv_id 进行验证，判断 bv_id 真实性",
    "score": "1",
    "rationale": "接口会调用 fetch_one_video 获取 cid；当 bv_id 无效导致 cid 缺失时会抛出错误并在响应中返回 message，可识别无效 bv_id"
  },
  {
    "rubric_id": "R04",
    "rubric_content": "接口必须支持 remove_watermark 可选参数且默认值为 0",
    "score": "1",
    "rationale": "down_video 定义了 remove_watermark 参数并设置 default=0，满足要求"
  },
  {
    "rubric_id": "R05",
    "rubric_content": "接口必须支持 resolution 可选参数且默认值为 0",
    "score": "1",
    "rationale": "down_video 定义了 resolution 参数并设置 default=0，满足要求"
  },
  {
    "rubric_id": "R06",
    "rubric_content": "检测 video 文件夹是否存在，下载的视频必须保存到项目根目录下的 video 目录。",
    "score": "1",
    "rationale": "接口会创建项目根目录下的 video 目录（os.makedirs(..., exist_ok=True)），并将文件保存到该目录，满足要求"
  },
  {
    "rubric_id": "R07",
    "rubric_content": "下载的视频文件名必须为 {bv_id}.mp4",
    "score": "1",
    "rationale": "保存路径使用 f\"{bv_id}.mp4\" 拼接文件名，输出为 mp4，满足要求"
  },
  {
    "rubric_id": "R08",
    "rubric_content": "当 {bv_id}.mp4 已存在时必须直接返回该文件路径",
    "score": "1",
    "rationale": "当文件存在且 remove_watermark=0 时会直接返回该文件路径；当 remove_watermark=1 时不会重复下载且最终返回同一路径，满足“存在即返回路径”的核心要求"
  },
  {
    "rubric_id": "R09",
    "rubric_content": "下载成功时必须返回与同模块其他接口一致的 ResponseModel 结构",
    "score": "1",
    "rationale": "成功返回使用 ResponseModel(code, router, data) 结构，与同文件其他接口一致，满足要求"
  },
  {
    "rubric_id": "R10",
    "rubric_content": "当 remove_watermark=1 时必须调用 ffmpeg 对输出视频做去水印处理",
    "score": "1",
    "rationale": "remove_watermark=1 分支会定位 ffmpeg/ffprobe 并调用基于 ffmpeg 的去水印处理流程，满足要求"
  },
  {
    "rubric_id": "R11",
    "rubric_content": "去水印策略必须明确针对右上角水印区域（包含 bilibili 字样）",
    "score": "1",
    "rationale": "水印检测逻辑对右上角区域设置了偏置，并在右上角场景设定最小框，明确针对右上角常见 bilibili 水印区域，满足要求"
  },
  {
    "rubric_id": "R12",
    "rubric_content": "关键处理链路（下载、保存、ffmpeg 去水印）必须包含注释说明",
    "score": "0",
    "rationale": "当前对 ffmpeg 合并/去水印与水印检测等部分有注释，但下载与分块写入（例如 _fetch_data_stream）等关键链路缺少对应注释，未完全满足“下载、保存、ffmpeg 去水印都必须有注释”的二元要求"
  },
  {
    "rubric_id": "R13",
    "rubric_content": "当环境未安装 ffmpeg 时必须给出清晰可操作的错误提示",
    "score": "1",
    "rationale": "当调用去水印/探测帧等需要 ffmpeg/ffprobe 的路径时，未找到会抛出包含安装与路径提示的错误信息，满足要求"
  },
  {
    "rubric_id": "R14",
    "rubric_content": "下载失败时必须返回可定位问题的错误信息（包含异常 message）",
    "score": "1",
    "rationale": "异常捕获会将 message=str(e) 写入 ErrorResponseModel 并返回，包含可定位错误信息，满足要求"
  },
  {
    "rubric_id": "R15",
    "rubric_content": "resolution=1/2 时必须尝试获取 720p/1080p（或更高）的视频流",
    "score": "1",
    "rationale": "实现将 resolution 映射为 bilibili 的 qn 并请求对应播放地址，且会在 DASH 流中择优选择目标高度或最接近的高度，满足“尝试获取 720p/1080p”的要求"
  },
  {
    "rubric_id": "R16",
    "rubric_content": "视频下载必须采用分块/流式写入文件，避免一次性读入内存",
    "score": "1",
    "rationale": "下载实现使用 aiter_bytes() 分块读取并写入文件，避免一次性读入内存，满足要求"
  },
  {
    "rubric_id": "R17",
    "rubric_content": "去水印输出必须先写入临时文件并在成功后原子替换最终文件，最后及时清理临时文件，防止占用存储空间",
    "score": "1",
    "rationale": "去水印输出写入临时文件并使用 os.replace 原子替换，finally 中清理临时文件，满足要求"
  }
]
